<!DOCTYPE html>
<!-- Start of html doc -->
<html lang="en">
  <!-- Container for meta data -->
  <head>
      <!-- Required meta tags -->
    <meta charset="utf-8">
    <!-- Mobile-optimized website: https://developer.mozilla.org/en-US/docs/Web/HTML/Viewport_meta_tag -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- JAVASCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <!-- STYlE:
        Import documentation from Bootstrap; at https://getbootstrap.com/docs/5.3/getting-started/introduction/
        alternative themes at https://bootswatch.com/ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Import own CSS style sheet -->
    <link href="../bootstrap.css" rel="stylesheet">
    <link href="../style.css" rel="stylesheet">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/arduino-light.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/arduino.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script> 
    <!-- Title of page -->
    <title>PS70_09_Networking</title>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary bg-dark border-bottom border-body" data-bs-theme="dark">
      <div class="container-fluid">
          <a class="navbar-brand mb-0 h1" href="../index.html">HOME</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
              <a class="nav-link" href="../about.html">About</a>
              </li>
              <li class="nav-item">
              <a class="nav-link" href="../finalproject/index.html">Final Project</a>
              </li>
              <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="../assignments.html" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Assignments
              </a>
              <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="../01_intro/index.html">01 - Intro</a></li>
                  <li><a class="dropdown-item" href="../02_2Ddesign/index.html">02 - 2D Design & Cutting</a></li>
                  <li><a class="dropdown-item" href="../03_fabrication/index.html">03 - Hand Tools & Fabrication</a></li>
                  <li><a class="dropdown-item" href="../04_microcontroller/index.html">04 - Microcontrollers</a></li>
                  <li><a class="dropdown-item" href="../05_3Ddesign/index.html">05 - 3D Design & Printing</a></li>
                  <li><a class="dropdown-item" href="../06_input/index.html">06 - Electronic Input Devices</a></li>
                  <li><a class="dropdown-item" href="../07_output/index.html">07 - Electronic Output Devices</a></li>
                  <li><a class="dropdown-item" href="../08_CNC/index.html">08 - CNC Miling</a></li>
                  <li><a class="dropdown-item" href="../09_networking/index.html">09 - Radio, WiFi & Bluetooth</a></li>
                  <li><a class="dropdown-item" href="../10_machine/index.html">10 - Machine Building & Effectors</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="../finalproject/index.html">Final Project</a></li>
              </ul>
              </li>
          </ul>
          </div>
      </div>
    </nav>

    <div class="container-fluid text-center">
        <div class="row justify-content-center">
            <div class="col-8">
              <h1>WEEK 9: Networking and IoT</h1>
              <h2></h2>
              <h4><i>ESP32 continued, Firebase, Web Apps</i></h4>
              <b>Assignment:</b>
              <a href="https://nathanmelenbrink.github.io/ps70/09_networking/index.html" target="_blank">PS70 website - week 9</a>
            </div>
        </div>
    </div>
    <div class="container-fluid text-start">
        <div class="row justify-content-center">
            <div class="col-6">
                <p>Work with a partner or group of 3.
                  <ul>
                    <li>Program one or more microcontroller(s) to obtain and respond to information from the internet or radio.</li>
                    <li>Your project should include at least one input and one output.</li>
                  </ul>
                </p> 
            </div>
        </div>
    </div>
    <div class="container-fluid text-start">
        <div class="row justify-content-center">
            <div class="col-8">
                <h2>Control a LED from This Website!</h2>
                <p>I followed the <a href="https://randomnerdtutorials.com/esp32-firebase-realtime-database/" target="_blank">Random Nerd Tutorial</a> 
                on using a ESP32 to write and read information to and from a realtime database on Firebase. Reading through 
                the tutorial, following the steps and using the code provided by the authors worked. However, it was a bit 
                harder to adjust Nathan's code on the LED to make it work. I mainly used the set up from the NerdTutorial code. 
                However, I also had to switch <b><i>Firebase.set</i></b> to <b><i>Firebase.RTDB.set</i></b>. Furthermore, I also figure out I 
                had to add a '<b>&</b>' before the firebase data object in the <b><i>firebase.RTDB.set()</i></b> and <b><i>Firebase.RTDB.get()</i></b> 
                functions. <br><br>
                <b>Example:</b> Firebase.<b>RTDB</b>.set(<b>&</b>firebaseData, "/LED_STATUS", "OFF"); <br><br>
                After those changes the code worked and I was able to control the LED by manually changing my variable in the 
                Realtime Database Console.</p>
                <p><video controls class="img-fluid" style="width:50%; height:50%;">
                        <source src="./PS70_w9_LED_manual.MOV" type="video/mp4">
                    </video></p>
                <p><img src="./LED_firebase_circuit.jpg" class="img-thumbnail" alt="ESP32 circuit LED - Firebase" style="width:50%; height:50%;"></p>
                <p></p>
                <p>Next, I used Nathan's code for ON and OFF buttons on webpages and included my own url and APi key. See the 
                    buttons below.<br>
                    <button id="turn-on" name="turnon">Turn On</button>
                    <button id="turn-off" name="turnoff">Turn Off</button>
                    <!-- The core Firebase JS SDK is always required and must be listed first -->
                    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-app.js"></script>

                    <!-- TODO: Add SDKs for Firebase products that you want to use
                        https://firebase.google.com/docs/web/setup#available-libraries -->
                    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-database.js"></script>

                    <script>
                    // Your web app's Firebase configuration
                    var firebaseConfig = {
                        apiKey: "AIzaSyBnfXfi-VzYYfbdmD_0S91TUKo3a975G7g",
                        authDomain: "REPLACE_WITH_YOUR_OWN",
                        databaseURL: "https://ps70week9-default-rtdb.firebaseio.com",
                        projectId: "REPLACE_WITH_YOUR_OWN",
                        storageBucket: "REPLACE_WITH_YOUR_OWN",
                        messagingSenderId: "REPLACE_WITH_YOUR_OWN",
                        appId: "REPLACE_WITH_YOUR_OWN"
                    };
                        // Initialize Firebase
                    firebase.initializeApp(firebaseConfig);

                    // Get a database reference to our blog
                    var ref = firebase.database().ref("/");

                    // make the buttons call the function below 
                    document.getElementById('turn-on').addEventListener('click', turnOn, false);
                    document.getElementById('turn-off').addEventListener('click', turnOff, false);

                    function turnOn(){
                        console.log("turning on");
                        ref.update({
                            "LED_STATUS": "ON"
                        });
                    }

                    function turnOff(){
                        console.log("turning off");
                        ref.update({
                            "LED_STATUS": "OFF"
                        });
                    }    
                </script>
                </p>
                <p><video controls class="img-fluid" style="width:50%; height:50%;">
                    <source src="./PS70_w9_LED_websitebuttons.MOV" type="video/mp4">
                    </video></p>
                <p></p>
                <p>
                    <h4>ARDUINO CODE:</h4>
                    <script src="https://strapdownjs.com/v/0.2/strapdown.js"> </script>
                    <xmp>
                /*
                Rui Santos
                Complete project details at our blog.
                    - ESP32: https://RandomNerdTutorials.com/esp32-firebase-realtime-database/
                    - ESP8266: https://RandomNerdTutorials.com/esp8266-nodemcu-firebase-realtime-database/
                Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files.
                The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
                Based in the RTDB Basic Example by Firebase-ESP-Client library by mobizt
                https://github.com/mobizt/Firebase-ESP-Client/blob/main/examples/RTDB/Basic/Basic.ino
                */
                
                #include <Arduino.h>
                #if defined(ESP32)
                #include <WiFi.h>
                #elif defined(ESP8266)
                #include <ESP8266WiFi.h>
                #endif
                #include <Firebase_ESP_Client.h>
                
                //Provide the token generation process info.
                #include "addons/TokenHelper.h"
                //Provide the RTDB payload printing info and other helper functions.
                #include "addons/RTDBHelper.h"
                
                // Insert your network credentials
                #define WIFI_SSID "MAKERSPACE"
                #define WIFI_PASSWORD "12345678"
                
                // Insert Firebase project API Key
                #define API_KEY "AIzaSyBnfXfi-VzYYfbdmD_0S91TUKo3a975G7g"
                
                // Insert RTDB URLefine the RTDB URL */
                #define DATABASE_URL "https://ps70week9-default-rtdb.firebaseio.com" 
                
                String fireString = "";                                          // led status received from firebase
                int ledpin = 5;
                
                //Define Firebase Data object
                FirebaseData firebaseData;
                
                FirebaseAuth auth;
                FirebaseConfig config;
                
                unsigned long sendDataPrevMillis = 0;
                int intValue;
                float floatValue;
                bool signupOK = false;
                
                void setup() {
                Serial.begin(115200);
                pinMode(ledpin, OUTPUT);
                WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
                Serial.print("Connecting to Wi-Fi");
                while (WiFi.status() != WL_CONNECTED) {
                    Serial.print(".");
                    delay(300);
                }
                Serial.println();
                Serial.print("Connected with IP: ");
                Serial.println(WiFi.localIP());
                Serial.println();
                
                /* Assign the api key (required) */
                config.api_key = API_KEY;
                
                /* Assign the RTDB URL (required) */
                config.database_url = DATABASE_URL;
                
                /* Sign up */
                if (Firebase.signUp(&config, &auth, "", "")) {
                    Serial.println("ok");
                    signupOK = true;
                }
                else {
                    Serial.printf("%s\n", config.signer.signupError.message.c_str());
                }
                
                /* Assign the callback function for the long running token generation task */
                config.token_status_callback = tokenStatusCallback; //see addons/TokenHelper.h
                
                Firebase.begin(&config, &auth);
                Firebase.reconnectWiFi(true);
                
                Firebase.RTDB.set(&firebaseData, "/LED_STATUS", "OFF");              // set initial string of "OFF"
                }
                
                void loop() {
                Firebase.RTDB.get(&firebaseData, "/LED_STATUS");                     // get led status input from firebase
                fireString = firebaseData.stringData();                        // change to e.g. intData() or boolData()
                Serial.println(fireString);
                
                if (fireString == "ON") {                    // compare the input of led status received from firebase
                    Serial.println("Led Turned ON");
                    digitalWrite(ledpin, HIGH);                // make output led ON
                }
                
                else if (fireString == "OFF") {              // compare the input of led status received from firebase
                    Serial.println("Led Turned OFF");
                    digitalWrite(ledpin, LOW);                 // make output led OFF
                }
                
                else {
                    Serial.println("Please send ON/OFF");
                }
                
                delay(1000); 
                }
                    </xmp>
                </p>
                <h4>API TEST:</h4>
                <script>
                function getWeather() {
                    axios.get('https://api.weather.gov/stations/KBOS/observations/latest')
                        .then((response) => {
                            document.getElementByID("time").innerHTML = "Time: " +  response.data.properties.timestamp;
                            document.getElementByID("temp").innerHTML = "Outside Temperature (Celsius): " +  response.data.properties.temperature.value;
                            document.getElementByID("wind").innerHTML = "Wind Direction (degree): " +  response.data.properties.windDirection.value + ", Wind Speed (km/h): " +  response.data.properties.windSpeed.value;;
                            document.getElementByID("humid").innerHTML = "Humidity (percent): " +  response.data.properties.relativeHumidity.value;
                    });
                }
                </script>
            </div>
        </div>
    </div>
</body>
