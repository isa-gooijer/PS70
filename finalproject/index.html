<!-- FINAL PROJECT PAGE -->

<!DOCTYPE html>
<!-- Start of html doc -->
<html lang="en">
    <!-- Container for meta data -->
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <!-- Mobile-optimized website: https://developer.mozilla.org/en-US/docs/Web/HTML/Viewport_meta_tag -->
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- JAVASCRIPT -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

        <!-- STYlE:
            Import documentation from Bootstrap; at https://getbootstrap.com/docs/5.3/getting-started/introduction/
            alternative themes at https://bootswatch.com/ -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <!-- Import own CSS style sheet -->
        <link href="../bootstrap.css" rel="stylesheet">
        <link href="../style.css" rel="stylesheet">
        
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/arduino-light.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/arduino.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
        <!-- Title of page -->
        <title>PS70_Final_Project</title>
    </head>
    
    <body>
        <nav class="navbar navbar-expand-lg bg-body-tertiary bg-dark border-bottom border-body" data-bs-theme="dark">
            <div class="container-fluid">
              <a class="navbar-brand mb-0 h1" href="../index.html">HOME</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                  <li class="nav-item">
                    <a class="nav-link" href="../about.html">About</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../finalproject/index.html">Final Project</a>
                  </li>
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="../assignments.html" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      Assignments
                    </a>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="../01_intro/index.html">01 - Intro</a></li>
                      <li><a class="dropdown-item" href="../02_2Ddesign/index.html">02 - 2D Design & Cutting</a></li>
                      <li><a class="dropdown-item" href="../03_fabrication/index.html">03 - Hand Tools & Fabrication</a></li>
                      <li><a class="dropdown-item" href="../04_microcontroller/index.html">04 - Microcontrollers</a></li>
                      <li><a class="dropdown-item" href="../05_3Ddesign/index.html">05 - 3D Design & Printing</a></li>
                      <li><a class="dropdown-item" href="../06_input/index.html">06 - Electronic Input Devices</a></li>
                      <li><a class="dropdown-item" href="../07_output/index.html">07 - Electronic Output Devices</a></li>
                      <li><a class="dropdown-item" href="../08_CNC/index.html">08 - CNC Miling</a></li>
                      <li><a class="dropdown-item" href="../09_networking/index.html">09 - Radio, WiFi & Bluetooth</a></li>
                      <li><a class="dropdown-item" href="../10_machine/index.html">10 - Machine Building & Effectors</a></li>
                      <li><a class="dropdown-item" href="../11_project_integration/index.html">11 - Project Integration</a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="../finalproject/index.html">Final Project</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
          <div class="container-fluid text-center">
            <div class="row">
              <div class="col">
                  <h1>AUTOMATIC WATERING SYSTEM FOR PLANT</h1>
                  <h2>Final Project</h2>
                  <b>Project Proposal: </b>
                  <a href="../01_intro/index.html">Week 1: Intro</a> <br>
                  <b>Project Progress: </b>
                  <a href="../11_project_integration/index.html">Week 11: Project Integration</a><br><br>
              </div>
            </div>
        </div>

        <div class="container-fluid text-start">
            <div class="row justify-content-center">
                <div class="col-8">
                    An automated watering system that updates at a <i>chosen interval</i>. The program will measure the current soil moisture 
                    and automatically calculate how much water (mL) needs to be added to reach the desired <i>water content</i>. 
                    It also automatically drives the <b>peristaltic pump</b> and runs it for the required time to add the extra water 
                    to the soil. The system requires <i>calibration</i> of the <b>soil moisture sensor</b> to the type of soil. 
                    Furthemore, it requires the pump speed (mL/s) of the peristaltic pump is determined for the used power level. 
                    Additionally, there is a <b>red LED</b> that will turn on if the water content in the soil is higher than the 
                    maximum content. This means something has gone wrong and the soil is oversaturated (more water than the soil can hold onto).
                    <br><br>
                </div>
            </div>
        </div>

        <div class="container-fluid text-start">
            <div class="row justify-content-center">
                <div class="col-8">
                  <h2>HOW IT WORKS: A Demonstration Video</h2>
                  <p>The program runs every 30 seconds. It reads the soil moisture in the soil, determines if it is too low, 
                    calculates how much water needs to be added and turns on the peristaltic pump for that required time. It also 
                    checks if the soil moisture is above the max (saturation of soil) and turns on a warning LED if it is.<br>
                    Check out the different responses for <b>dry soil</b>, <b>wet soil</b>, and <b>pure water</b>.
                  </p>
                  <p><b>LINK TO VIDEO IN <a href="https://drive.google.com/file/d/1TIxbeobQa5rUTlNJnhcrZFWUyF1o9GzU/view?usp=drive_link" target="_blank">GOOGLE DRIVE<br>
                    <img src="./Demo_video_title_still.jpg" class="img-fluid" style="width: 50%; height: 50%;">
                  </a></b></p>
                  <p>This video is to show how program works. It is meant to demonstrate that the peristaltic pump (and LED) responds 
                    to different levels of soil moisture and that the program can cal calculate and add the correct water amount (mL) 
                    to reach the desired water content/soil moisture. However, in actual use the program would update less frequently (hours) 
                    and also the pump and soil moisture sensor are located in the box (see pictures on this page). 
                  </p>

                  <p></p>
                  <h4>Pictures of finished product:</h4>
                  <p>Front view (open front)
                    <img src="./box_pump_sensor_openfront.jpg" class="img-fluid">
                  </p>
                  <p>Top view
                    <img src="./box_pump_sensor_topview.jpg" class="img-fluid">
                  </p>
                  <p>Back view: wiring (open back)
                    <img src="./Wiring_box_openback.jpg" class="img-fluid">
                  </p>

                  <p></p>
                  <h3>A Box without Glue: Easily Build and Taken Apart!</h3>
                  No glue, no screws, just cartboard and Mortise and Tenon joints. Easy to assembled and easy to take apart.<br>
                  <p>
                    Download the <a href="./Final_project_box.stl" download>STL file</a>
                    <iframe src="https://college269.autodesk360.com/shares/public/SHd38bfQT1fb47330c99f000e15812a7289d?mode=embed" width="640" height="480" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"  frameborder="0"></iframe>
                  </p>
                  <p>Dowload the DFX files:
                    <ul>
                      <li><a href="./IsaG_V1_bottom_lasercut.dxf">Bottom</a></li>
                      <li><a href="./IsaG_V1_width_lasercut.dxf">Width</a> (2x)</li>
                      <li><a href="./IsaG_V1_lenght_front_lasercut.dxf">Front</a></li>
                      <li><a href="./IsaG_V1_lenght_back_lasercut.dxf">Back</a></li>
                      <li><a href="./IsaG_V1_middlepiece_lasercut.dxf">Middle Piece</a></li>
                      <li><a href="./IsaG_V1_motor_plateau.dxf">Motor Plateau</a></li>
                    </ul>
                    <br>
                    <img src="../11_project_integration/assembled_empty_side.jpg" class="img-fluid"><br><br>
                    <img src="../11_project_integration/unassembled_ALL_pieces.jpg" class="img-fluid"><br>
                    <br>
                    For assembly of the box check out the final project <a href="../11_project_integration/index.html">progress page</a>! 
                    Make sure to do the wiring before pushing in the back plate.
                  </p>

                  <h3>Calibration of the Soil Moisture Sensor:</h3>
                  <p></p>
                  <p><u><b>Needed:</b></u>
                    <ul>
                      <li>Arduino or ESP32C3 with wiring, cable, etc.</li>
                      <li>Soil Moisture Sensor (obviously)</li>
                      <li>Potting soil</li>
                      <li>Transparent/translucent plastic cup (to put the soil in)</li>
                      <li>Coffee filters</li>
                      <li>Scale</li>
                      <li>Spoon (to move soil into cup)</li>
                      <li>Spoon (to drip water onto soil)</li>
                      <li>Tape</li>
                    </ul>
                  </p>
                  <p>
                    <b>Step 1: Set up the soil moisture sensor</b><br>
                    Use the schematic and code below. Measure and save the sensor value in air and pure water.
                    Download the <a href="./Soil_moist_calibrate.ino" download>calibration code</a><br><br>
                    <b>Step 2:</b><br>
                    Prepare the cup. Put the coffee filter in the cup and secure to cup with tape.<br>
                    Save the weight.<br>
                    <img src="./soil_moist_calibration_setup_nosoil.jpg" class="img-fluid">
                    <br><br>
                    <b>Step 3:</b><br>
                    Add soil, push down on it sligtly, measure and save the weight (dry_weight). Add the soil moisture sensor. Wait 
                    2 minutes then save the soil moisture sensor value.<br>
                    <img src="./soil_moist_calibration_setup_dry.jpg" class="img-fluid"><br><br>
                    <b>Step 4:</b><br>
                    Add 15 mL of water to the soil, distribute evenly. Wait 2 minutes and save value.<br>
                    <img src="./soil_moist_calibration_1.jpg" class="img-fluid">
                    <br><br>
                    <b>Step 5:</b><br>
                    Repeat step 4 until the coffee filter starts dripping from the bottom. This means the soil is saturated and 
                    cannot hold more water.<br>
                    <img src="./soil_moist_calibration_leaking.jpg" class="img-fluid">
                    <img src="./soil_moist_calibration_leaking_closeup.jpg" class="img-fluid"><br><br>
                    <b>Step 6:</b><br>
                    Calculate the water content (by weight) in excel.<br>
                    <i>water content (wc) = (Weight_dry - Weight_total) / Weight_total <br>
                    wc = (W_tot - W_d) / W_tot <br>
                    wc = added water (mL) / (weight of dry soil + added water)</i><br><br>
                    <b>Step 7:</b> Make a graph and retrieve a formula<br>
                    Make a graph in excel with water content on the x axis and soil moisture sensor value on the y-axis. Create a 
                    linear trendline and display the formula. Determine and save <i>a</i> and <i>b</i> from the formula <i>y = ax + b</i>.<br>
                    <img src="./sensor_calibration_curve.png" class="img-fluid">
                  </p>

                  <h3>Determining Speed of the Peristaltic Pump:</h3>
                  <p><u><b>Needed:</b></u>
                    <ul>
                        <li>Arduino or ESP32C3 with wiring, cable, etc.</li>
                        <li>Peristaltic pump</li>
                        <li>Bottle with water</li>
                        <li>Empty plastic cup</li>
                        <li>Scale</li>
                    </ul>
                  </p>
                  <p><b>Step 1:</b> Set up the peristaltic pump<br>
                  Use the schematic and code below to set up the peristaltic pump for testing.
                  Download the <a href="./Peristaltic_pump_calibrate.ino" download>calibration code</a><br><br>
                  <b>Step 2:</b><br>
                  Let the peristaltic pump run for 5 seconds at different power levels (0-255). Determine the amount of 
                  water that is being pumped in 5 seconds (determine weight with a scale).<br><br>
                  <b>Step 3:</b>
                  Repeat 4 times and determine the average over 4 trials.<br><br>
                  <b>Step 4:</b><br>
                  Convert to mL/s by diving volume by time (5s). Determine what power level you like/want to use and save 
                  that value for later.<br>
                  <img src="./pump_table.png" class="img-fluid"><br><br>
                  <img src="./pump_calibration_curve.png" class="img-fluid">
                  </p>

                  <h3>ESP32C3 CODE: Soil Moisture Sensor and Peristaltic Pump Working Together!</h3><br>
                  <p><u><b>Needed:</b></u>
                    <ul>
                      <li>Values <b><i>a</i></b> and <b><i>b</i></b> from soil moisture sensor calibration</li>
                      <li>Max water content (when soil is saturate) from soil moisture sensor calibration</li>
                      <li>Pump speed from peristaltic pump calibration</li>
                      <li>Pin for sensore, pump and LED</li>
                      <li>Dry weight of the soil in the cup (before it was ever watered).</li>
                      <li>Choose desired water content (by weight, <i>e.g., 0.35 so 35% of the total weight is water</i>); must be 
                      below the max water content/saturation value.</li>
                    </ul>                  
                  </p>
                  <u><b>Calculations explained:</b></u><br>
                  <i><b>y = ax + b</b></i> where <b>y</b> is the value measure by the moisture sensor, <b>a</b> is the slope and 
                  <b>b</b> is the sensor value for dry soil (a and b determined at calibration). Solve for <b>x</b> to get the <i>water content</i>.
                  <br>
                  <i><b>x = (y - b) / a</b></i>
                  <br><br>
                  Get the amount of water to add to get the desired water content:<br>
                  <b><i>Water to add (mL) = (W_d/(1-wc_desired)) - (W_d/(1-wc_current))</i></b><br>
                  <br>
                  Deriving the formula:<br>
                  Known variables are <b>y</b> (sensor value, soil moisture), <b>x</b> (water content, <b>wc</b>), and dry weight (<b>W_d</b>) 
                  (measured at calibration). Want to get the total weight (W_tot) of soil + water at a given point.<br>
                  <i>water content (wc) = (W_tot - W_d) / W_tot</i> and we want to know W_tot (total weight).<br><br>
                  <img src="./delta_water_vol_derive.jpg" class="img-fluid"><br><br>

                  <p>Download the <a href="./Soil_pump_calibrate_EPS32C3/Soil_pump_calibrate_EPS32C3.ino" download>final ESP32C3 code</a>!</p>
                  <p>
                    <pre><code class="language-arduino">
      // SOIL MOISTURE - PERISTALTIC PUMP - CALIBRATED

      // EPS32C3 (conversion)

      class SoilMoist {
        // CLASS MEMBER VARIABLES
        // variables that are INITIRALIZED AT STARTUP
        int SM_pin; //soil moisture sensor pin
        int ledPin; // pin of LED
        int pumpPin; // pin of pump
        
        //GET THESE VALUES
        // higher value is in air, lower value in water
        int interval; // interval at which soil moisture values is read (milliseconds)
        float desired_wc; // the desired water content by weight (wc_d)
        
        // GET THESE VALUES FROM CALIBRATION (fill out in FIREBASE)
        // int water_min; // minimum value sensor (pure water)
        // int air_max; // maximum value sensor (air)
        float b_dry_soil; // soil moisture sensor value from dry soil.
        float soil_max_wc; // the water content of saturated soil, refer to calibration curve. 
        float a_slope; // the slope from the linear fitted line from calibration.
        float speed_pump; // how many mL/s are moved by the pump. (seconds)
        // weight the dry soil (doesn't need to be from calibration)
        float dry_weight; // the dry weight of the soil (W_dry) when it was put into the pot/cup without addition of water. (GRAMS)


        // variables that maintain CURRENT STATE
        // GET FROM SENSOR: 
        int y_soil_sensor; // value from the soil moisture sensor
        
        // CALCULATE:
        // water content by weight (so % water of the total weight)
        float x_current_wc; // current water content by weight (wc_c). This is x from y = a*x + b (y_soil_sensor = a_slope * x + b_dry_soil).
        float delta_water_vol; // change in water volume, aka how much mL needs to be added/pumped.
        int time_pump; // time pump is on to get desired water content. (in milliseconds)

        // to keep check of time
        unsigned long lastUpdate; // last update (in milliseconds)


        public:
        SoilMoist(int SENSOR, int LED, int PUMP, int INT,  float a, float b, float W_d, float soilMAX_wc, float desiredWC, float PUMPspeed){
          SM_pin = SENSOR;
          ledPin = LED;
          pumpPin = PUMP;
          interval = INT;
          a_slope = a;
          b_dry_soil = b;
          dry_weight = W_d;
          soil_max_wc = soilMAX_wc;
          desired_wc = desiredWC;
          speed_pump = PUMPspeed;
          
          pinMode(ledPin, OUTPUT); // set LED pin to an OUTPUT
          pinMode(pumpPin, OUTPUT); // set pump pin to an OUTPUT
          lastUpdate = 0; // start clock at zero
        }

        void Update(){
          // check to see if it's time to read of the soil moisture value
          if(millis() - lastUpdate >= interval){
            lastUpdate = millis();
            y_soil_sensor = analogRead(SM_pin);
            x_current_wc = (analogRead(SM_pin) - b_dry_soil) / a_slope; // x = (y-b)/a where y is value from sensor, a and b are derived from the calibration of the sensor.
            delta_water_vol = (dry_weight/(1 - desired_wc)) - (dry_weight/(1 - x_current_wc));
            time_pump = delta_water_vol / speed_pump * 1000; // *1000 to get milliseconds.

            Serial.println("NEW MEASUREMENT");
            Serial.println("Interval: " + String(interval));
            Serial.println("a_slope: " + String(a_slope));
            Serial.println("b_dry_soil: " + String(b_dry_soil));
            Serial.println("dry weight: " + String(dry_weight));
            Serial.println("soil_max_wc: " + String(soil_max_wc));
            Serial.println("desired_wc: " + String(desired_wc));
            Serial.println("Sensor Value:" + String(y_soil_sensor));
            Serial.println("current_cw: " + String(x_current_wc));
            Serial.println("delta_water_vol: " + String(delta_water_vol));
            Serial.println("time_pump: " + String(time_pump/1000));

            x_current_wc = (y_soil_sensor - b_dry_soil) / a_slope; // x = (y-b)/a where y is value from sensor, a and b are derived from the calibration of the sensor.
            
            if (x_current_wc >= soil_max_wc) {
              digitalWrite(ledPin, HIGH); // turn on LED to show that something is wrong. The water content is equal to or higher than the saturated soil --> too much water!
            }

            else if (x_current_wc &lt desired_wc){
              delta_water_vol = (dry_weight/(1 - desired_wc)) - (dry_weight/(1 - x_current_wc));
              time_pump = delta_water_vol / speed_pump * 1000; // *1000 to get milliseconds.
              
              //Serial.println("delta water volume:" + String(delta_water_volume));
              //Serial.println("time pump is on (ms):" + String(time_pump));
              
              // led pump run for the calculated time to add the estimated amount of water to reach desired water content in the soil.
              analogWrite(pumpPin, 255);
              delay(time_pump);
              analogWrite(pumpPin, 0);

              digitalWrite(ledPin, LOW); // turn off red LED
            }

            else {
              digitalWrite(ledPin, LOW); // turn off red LED
            }
          }
        }
      };

      // sensor pin = 4, led pin = 3, pump pin = 7.
      // interval is 30 sec. --&gt 30000 ms
      // FROM CALIBRATION (EPS32C3):
      // a = -2363.4
      // b = 32675.2
      // W_d = 100 (g)
      // soil_max_wc = 0.436
      // desired_wc = 0.35
      // pump_speed (255) = 2.3 mL/s

      SoilMoist sm1(4, 3, 7, 30000, -2363.4, 2675.2, 100, 0.436, 0.35, 2.3);

      void setup() {
      Serial.begin(9600);
      }

      void loop() {
        sm1.Update();
      }


                    </code></pre>
                  </p>

                </div>
            </div>
        </div>

    </body>

    </html>
